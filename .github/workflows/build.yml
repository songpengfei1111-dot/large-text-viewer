name: Build All Platforms

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: large-text-viewer
            asset_name: large-text-viewer-linux
          - os: windows-latest
            artifact_name: large-text-viewer.exe
            asset_name: large-text-viewer-windows
          - os: macos-latest
            artifact_name: large-text-viewer
            asset_name: large-text-viewer-macos
    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-target-

    - name: Run Clippy
      if: matrix.os == 'windows-latest'
      id: clippy
      shell: bash
      run: |
        if ! cargo clippy --release --color never -- -D warnings 2> clippy_output.txt; then
          echo "## Clippy Issues" >> $GITHUB_STEP_SUMMARY
          echo "<pre>" >> $GITHUB_STEP_SUMMARY
          cat clippy_output.txt >> $GITHUB_STEP_SUMMARY
          echo "</pre>" >> $GITHUB_STEP_SUMMARY
          cat clippy_output.txt
          echo "failure=true" >> $GITHUB_OUTPUT
        else
          echo "## Clippy Check Passed :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "No issues found. Great job!" >> $GITHUB_STEP_SUMMARY
          echo "failure=false" >> $GITHUB_OUTPUT
        fi

    - name: Comment Clippy Results
      if: matrix.os == 'windows-latest' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const failure = '${{ steps.clippy.outputs.failure }}';
          const fs = require('fs');
          try {
            let body;
            if (failure === 'true') {
              const output = fs.readFileSync('clippy_output.txt', 'utf8');
              const maxLength = 60000;
              body = '## Clippy Issues\n\n```\n' + output + '\n```';
              if (body.length > maxLength) {
                 body = '## Clippy Issues\n\n```\n' + output.substring(0, maxLength) + '\n... (truncated)\n```';
              }
            } else {
              body = '## Clippy Check Passed :white_check_mark:\n\nGreat job! No issues found.';
            }
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } catch (error) {
            console.log('Error posting comment:', error);
          }

    - name: Build release
      run: cargo build --release --verbose

    - name: Run tests
      run: cargo test --release --verbose

    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: target/release/${{ matrix.artifact_name }}
        if-no-files-found: error
        retention-days: 5

